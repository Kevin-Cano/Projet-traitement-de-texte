{% extends 'base.html.twig' %}

{% block title %}Tableau de Bord Analytique{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stats-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .chart-container canvas {
            max-width: 100% !important;
            height: auto !important;
        }
        
        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .productivity-meter {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .book-progress {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-bar-container {
            flex: 1;
            margin: 0 1rem;
        }
        
        .analytics-nav {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .metric-trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-stable { color: #6c757d; }
    </style>
{% endblock %}

{% block body %}
<div class="analytics-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="bi bi-graph-up me-3"></i>
                    Tableau de Bord Analytique
                </h1>
                <p class="mb-0 mt-2 opacity-75">
                    Analyse compl√®te de votre progression et productivit√© d'√©criture
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex gap-2 justify-content-end">
                    <button class="btn btn-light btn-sm" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i> Actualiser
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> Exporter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ path('app_analytics_export', {type: 'full-report'}) }}">Rapport complet</a></li>
                            <li><a class="dropdown-item" href="{{ path('app_analytics_export', {type: 'progression'}) }}">Donn√©es de progression</a></li>
                            <li><a class="dropdown-item" href="{{ path('app_analytics_export', {type: 'productivity'}) }}">Donn√©es de productivit√©</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Navigation rapide -->
    <div class="analytics-nav">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="period" id="period7" value="7" checked>
                    <label class="btn btn-outline-primary btn-sm" for="period7">7 jours</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period30" value="30">
                    <label class="btn btn-outline-primary btn-sm" for="period30">30 jours</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period90" value="90">
                    <label class="btn btn-outline-primary btn-sm" for="period90">90 jours</label>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="refreshDashboard()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Actualiser
                </button>
                <select class="form-select form-select-sm" id="bookFilter" style="max-width: 200px; display: inline-block;">
                    <option value="">Tous les livres</option>
                    {% for livre in livres %}
                        <option value="{{ livre.id }}">{{ livre.titre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Statistiques principales -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number" id="totalWords">{{ stats.total_words|number_format }}</div>
                <div class="stats-label">Mots √©crits</div>
                <div class="metric-trend trend-up">
                    <i class="bi bi-arrow-up"></i> +12% cette semaine
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ stats.total_chapters }}</div>
                <div class="stats-label">Chapitres</div>
                <div class="metric-trend trend-up">
                    <i class="bi bi-arrow-up"></i> +2 ce mois
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ stats.reading_time_hours }}h</div>
                <div class="stats-label">Temps de lecture</div>
                <div class="metric-trend trend-stable">
                    <i class="bi bi-dash"></i> Stable
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ stats.total_characters }}</div>
                <div class="stats-label">Personnages</div>
                <div class="metric-trend trend-up">
                    <i class="bi bi-arrow-up"></i> +1 r√©cemment
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Graphique de progression -->
        <div class="col-lg-8">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Progression d'√©criture
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleChartType()">
                        <i class="bi bi-bar-chart"></i> Changer le type
                    </button>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="progressionChart"></canvas>
                </div>
            </div>

            <!-- Analyse de productivit√© -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Analyse de productivit√©
                </h5>
                <div class="row">
                    <div class="col-md-8">
                                                 <div style="position: relative; height: 200px;">
                             <canvas id="productivityChart"></canvas>
                         </div>
                    </div>
                    <div class="col-md-4">
                        <div class="productivity-meter">
                            <canvas id="productivityGauge" width="200" height="200"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <h6>Score de productivit√©</h6>
                            <span class="badge bg-success fs-6" id="productivityScore">85%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panneau lat√©ral -->
        <div class="col-lg-4">
            <!-- Progression par livre -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-book me-2"></i>
                    Progression par livre
                </h5>
                {% for livre in livres %}
                    <div class="book-progress">
                        <div class="book-info">
                            <strong>{{ livre.titre }}</strong>
                            <br>
                            <small class="text-muted">{{ livre.chapitres|length }} chapitres</small>
                        </div>
                        <div class="progress-bar-container">
                            {% set progress = (livre.mots_total ?? 0) / (livre.objectif_mots ?? 10000) * 100 %}
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ min(100, progress) }}%">
                                    {{ progress|round }}%
                                </div>
                            </div>
                        </div>
                        <div class="book-stats">
                            <small>{{ livre.mots_total|default(0)|number_format }} mots</small>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Insights rapides -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-lightbulb me-2"></i>
                    Insights
                </h5>
                <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex align-items-start">
                        <div class="badge bg-primary rounded-pill me-3">üí°</div>
                        <div>
                            <strong>Meilleur moment d'√©criture</strong><br>
                            <small class="text-muted">Vous √™tes plus productif entre 9h et 11h</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-start">
                        <div class="badge bg-success rounded-pill me-3">üìà</div>
                        <div>
                            <strong>Progression constante</strong><br>
                            <small class="text-muted">+15% de mots cette semaine vs. pr√©c√©dente</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-start">
                        <div class="badge bg-warning rounded-pill me-3">‚ö°</div>
                        <div>
                            <strong>Objectif proche</strong><br>
                            <small class="text-muted">Plus que 2,500 mots pour votre objectif mensuel</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-start">
                        <div class="badge bg-info rounded-pill me-3">üéØ</div>
                        <div>
                            <strong>Recommandation</strong><br>
                            <small class="text-muted">Essayez d'√©crire 350 mots/jour pour rester sur la bonne voie</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analyse de sentiment -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="bi bi-emoji-smile me-2"></i>
                    Analyse de sentiment
                </h5>
                <div style="position: relative; height: 200px;">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Fallback Chart.js si le CDN √©choue -->
    <script>
        if (typeof Chart === 'undefined') {
            console.warn('CDN Chart.js principal √©chou√©, tentative de fallback...');
            document.write('<script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"><\/script>');
        }
    </script>
    
    <script>
        // Configuration des graphiques
        let progressionChart = null;
        let productivityChart = null;
        let sentimentChart = null;
        let productivityGauge = null;
        
        // Donn√©es initiales
        const initialProgressionData = {{ progression|json_encode|raw }};
        const initialProductivityData = {{ productivity|json_encode|raw }};
        

        
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier si Chart.js est charg√©
            if (typeof Chart === 'undefined') {
                console.error('Chart.js n\'est pas charg√© !');
                return;
            }
            
            // Configuration globale de Chart.js pour √©viter les bugs de redimensionnement
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;
            Chart.defaults.resizeDelay = 200;
            
            initializeCharts();
            bindEventListeners();
        });
        
        function initializeCharts() {
            try {
                // Graphique de progression
                const progressionCtx = document.getElementById('progressionChart').getContext('2d');
                if (!progressionCtx) {
                    console.error('Canvas progressionChart non trouv√© !');
                    return;
                }
                
                progressionChart = new Chart(progressionCtx, {
                type: 'line',
                data: {
                    labels: initialProgressionData.map(d => d.date),
                    datasets: [{
                        label: 'Mots √©crits',
                        data: initialProgressionData.map(d => d.words),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    resizeDelay: 100,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
            
            // Graphique de productivit√©
            const productivityCtx = document.getElementById('productivityChart').getContext('2d');
            productivityChart = new Chart(productivityCtx, {
                type: 'bar',
                data: {
                    labels: initialProductivityData.map(d => d.date),
                    datasets: [{
                        label: 'Sessions',
                        data: initialProductivityData.map(d => d.sessions),
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        yAxisID: 'y'
                    }, {
                        label: 'Efficacit√© (%)',
                        data: initialProductivityData.map(d => d.efficiency),
                        type: 'line',
                        borderColor: '#28a745',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    resizeDelay: 100,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
            // Graphique de sentiment
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Positif', 'Neutre', 'N√©gatif'],
                    datasets: [{
                        data: [60, 30, 10],
                        backgroundColor: ['#28a745', '#6c757d', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    resizeDelay: 100,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Jauge de productivit√©
            createProductivityGauge();
            
            } catch (error) {
                console.error('Erreur lors de l\'initialisation des graphiques:', error);
                // Afficher un message d'erreur dans la page
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning mb-4';
                alertDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i><strong>Erreur:</strong> Impossible de charger les graphiques analytics. Consultez la console pour plus de d√©tails.';
                document.querySelector('.container-fluid').prepend(alertDiv);
            }
        }
        
        function createProductivityGauge() {
            const canvas = document.getElementById('productivityGauge');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;
            const score = 85; // Score de productivit√© en pourcentage
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner l'arri√®re-plan de la jauge
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI);
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 15;
            ctx.stroke();
            
            // Dessiner la progression
            const angle = Math.PI + (Math.PI * score / 100);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, Math.PI, angle);
            ctx.strokeStyle = score > 70 ? '#28a745' : score > 40 ? '#ffc107' : '#dc3545';
            ctx.lineWidth = 15;
            ctx.stroke();
            
            // Dessiner le texte
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText(score + '%', centerX, centerY + 8);
        }
        
        function bindEventListeners() {
            // Changement de p√©riode
            document.querySelectorAll('input[name="period"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateChartsData(this.value);
                });
            });
            
            // Filtre par livre
            document.getElementById('bookFilter').addEventListener('change', function() {
                updateChartsData(document.querySelector('input[name="period"]:checked').value, this.value);
            });
        }
        
        async function updateChartsData(period, bookId = '') {
            try {
                // R√©cup√©rer les nouvelles donn√©es
                const progressionResponse = await fetch(`{{ path('app_analytics_api_progression') }}?period=${period}&book_id=${bookId}`);
                const productivityResponse = await fetch(`{{ path('app_analytics_api_productivity') }}?period=${period}`);
                
                const progressionData = await progressionResponse.json();
                const productivityData = await productivityResponse.json();
                
                // Mettre √† jour les graphiques
                progressionChart.data.labels = progressionData.map(d => d.date);
                progressionChart.data.datasets[0].data = progressionData.map(d => d.words);
                progressionChart.update();
                
                productivityChart.data.labels = productivityData.map(d => d.date);
                productivityChart.data.datasets[0].data = productivityData.map(d => d.sessions);
                productivityChart.data.datasets[1].data = productivityData.map(d => d.efficiency);
                productivityChart.update();
                
                // Mettre √† jour les statistiques
                updateStats(progressionData, productivityData);
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour des donn√©es:', error);
            }
        }
        
        function updateStats(progressionData, productivityData) {
            const totalWords = progressionData.reduce((sum, d) => sum + d.words, 0);
            document.getElementById('totalWords').textContent = totalWords.toLocaleString();
        }
        
        function toggleChartType() {
            const currentType = progressionChart.config.type;
            const newType = currentType === 'line' ? 'bar' : 'line';
            
            progressionChart.config.type = newType;
            progressionChart.update();
        }
        
        function refreshDashboard() {
            const period = document.querySelector('input[name="period"]:checked').value;
            const bookId = document.getElementById('bookFilter').value;
            updateChartsData(period, bookId);
        }
        

        
        // Throttle pour le redimensionnement
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                if (progressionChart) progressionChart.resize();
                if (productivityChart) productivityChart.resize();
                if (sentimentChart) sentimentChart.resize();
            }, 250);
        });

        // Mise √† jour automatique toutes les 5 minutes
        setInterval(refreshDashboard, 300000);
    </script>
{% endblock %} 